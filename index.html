<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MY APP LUIS</title>

    <!-- Tailwind CSS (versi√≥n local) -->
    <link rel="stylesheet" href="./assets/css/tailwind.min.css">

    <!-- Manifest PWA -->
    <link rel="manifest" href="./manifest.json">

    <!-- Dexie (solo una vez, duplicado corregido) -->
    <script src="./assets/js/dexie.min.js"></script>

    <!-- FullCalendar -->
    <script src="./assets/js/index.global.min.js"></script>

    <!-- Responsive (tu archivo) -->
    <script src="./assets/js/responsive.js"></script>

    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f3f4f6; 
        }

        .tab-button.active { 
            border-color: #4f46e5; 
            color: #4f46e5; 
            background-color: #f5f3ff; 
        }

        .kanban-column { 
            min-width: 300px; 
            max-height: 75vh; 
            overflow-y: auto; 
            scrollbar-width: none; 
        }
        .kanban-column::-webkit-scrollbar { display: none; }

        .drag-hover { 
            border: 2px dashed #4f46e5; 
            background-color: #eef2ff; 
        }

        .kanban-card { cursor: grab; }
        .kanban-card:active { cursor: grabbing; }

        .editable-cell { 
            cursor: pointer; 
            padding: 4px 8px; 
            border-radius: 4px; 
            transition: background-color 0.15s; 
        }
        .editable-cell:hover { background-color: #f1f5f9; }

        .editable-cell input, 
        .editable-cell select {
            border: none;
            padding: 0;
            width: 100%;
            background: transparent;
            font-size: inherit;
            color: #1f2937;
        }
    </style>
</head>

<body class="min-h-screen flex">

    <!-- Bot√≥n men√∫ m√≥vil -->
    <button id="menu-toggle" class="md:hidden fixed top-4 left-4 z-50 p-2 bg-indigo-600 text-white rounded-lg">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                  d="M4 6h16M4 12h16M4 18h16"/>
        </svg>
    </button>

    <!-- SIDEBAR -->
    <aside id="sidebar" 
        class="w-64 bg-white shadow-xl flex-shrink-0 border-r border-gray-200 p-4 space-y-4
               transform -translate-x-full md:translate-x-0 transition-transform duration-200 ease-in-out
               fixed md:static z-40 h-screen md:h-auto">

        <h1 class="text-2xl font-bold text-indigo-700">MY APP LUIS</h1>

        <!-- Perfil Usuario -->
        <div id="user-profile-summary"
             class="bg-gray-50 p-3 rounded-lg flex items-center space-x-3 cursor-pointer hover:bg-gray-100"
             onclick="showUserModal()">

            <span id="user-avatar" class="text-3xl">üßë‚Äçüíª</span>

            <div>
                <p id="user-name-display" class="font-semibold text-gray-800">Cargando...</p>
                <p id="user-branch-display" class="text-xs text-gray-500">Configurar perfil</p>
            </div>

        </div>

        <!-- Men√∫ principal -->
        <div class="space-y-1">
            <button onclick="setActiveWorkspace(1)" 
                class="w-full text-left p-2 rounded-lg hover:bg-gray-100 text-gray-800 font-medium">
                <span class="mr-2">üè†</span> Dashboard
            </button>

            <button onclick="showModal('config-modal')"
                class="w-full text-left p-2 rounded-lg hover:bg-gray-100 text-gray-800 font-medium">
                <span class="mr-2">‚öôÔ∏è</span> Sincronizaci√≥n
            </button>
        </div>

        <hr class="border-gray-200">

        <h2 class="text-xs font-semibold uppercase text-gray-500 tracking-wider">Bases de Datos</h2>
        <div id="workspace-list" class="space-y-1"></div>

        <button onclick="addWorkspace()"
            class="w-full text-center py-2 rounded-lg bg-indigo-50 hover:bg-indigo-100 text-indigo-600 text-sm font-medium">
            + Nuevo Espacio
        </button>

    </aside>

    <!-- MAIN CONTENT -->
    <main class="flex-grow overflow-auto p-4 md:p-8 md:ml-0 transition-all duration-200">
        <header class="mb-6">
            <div class="flex justify-between items-center">

                <h2 id="current-workspace-title" 
                    class="text-4xl font-extrabold text-gray-900">Cargando...</h2>

                <div class="flex space-x-3">
                    <button id="btn-configure-ws"
                        onclick="showWorkspaceConfigModal()"
                        class="px-4 py-2 bg-gray-200 text-gray-700 font-semibold rounded-lg shadow-md hover:bg-gray-300 transition-colors hidden">
                        Configurar Propiedades
                    </button>

                    <button id="btn-sync" onclick="exportToGist()" 
                        class="px-4 py-2 bg-gray-200 text-gray-700 font-semibold rounded-lg shadow-md hover:bg-gray-300 transition-colors flex items-center space-x-2">
                        <span class="w-2 h-2 rounded-full bg-red-500" id="sync-indicator"></span>
                        <span id="sync-text">Desconectado Gist</span>
                    </button>

                    <button id="btn-new-item" onclick="showItemModal()"
                        class="px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition-colors">
                        + Nuevo Elemento
                    </button>
                </div>

            </div>

            <!-- Tabs -->
            <div id="view-tabs" 
                class="mt-4 flex space-x-2 p-1 bg-white rounded-xl shadow-inner max-w-fit"></div>
        </header>

        <section id="content-view" 
            class="bg-white p-6 rounded-xl shadow-lg min-h-[70vh]">
            <p class="text-center text-gray-500">Cargando datos...</p>
        </section>

        <div id="app-message" 
             class="fixed bottom-4 right-4 p-3 rounded-lg shadow-xl text-sm hidden"></div>
    </main>

    <!-- MODAL CREAR / EDITAR ELEMENTO -->
    <div id="item-modal"
         class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden items-center justify-center p-4 z-50">

        <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl p-6 overflow-y-auto max-h-[90vh]">

            <h3 id="item-modal-title"
                class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">Nuevo Elemento</h3>

            <form id="record-form" class="space-y-4">

                <input type="hidden" id="record-id">
                <input type="hidden" id="record-workspaceId">

                <div id="dynamic-properties-container" 
                    class="grid grid-cols-1 md:grid-cols-3 gap-4 border p-4 rounded-lg bg-gray-50"></div>

                <div>
                    <span class="text-gray-700 font-medium block mb-2">Bloque de Contenido</span>
                    <textarea id="record-content-block" rows="8"
                        placeholder="Contenido detallado..."
                        class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 focus:border-indigo-500 focus:ring-indigo-500 text-sm"></textarea>
                </div>

                <div class="mt-6 flex justify-end space-x-3">
                    <button type="button" 
                        onclick="deleteRecord(document.getElementById('record-id').value)"
                        id="btn-delete-record"
                        class="px-4 py-2 bg-red-500 text-white font-semibold rounded-lg hover:bg-red-600 hidden">
                        Eliminar
                    </button>

                    <button type="button" onclick="closeModal('item-modal')" 
                        class="px-4 py-2 bg-gray-300 text-gray-800 font-semibold rounded-lg hover:bg-gray-400">
                        Cancelar
                    </button>

                    <button type="submit"
                        class="px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700">
                        Guardar Elemento
                    </button>
                </div>

            </form>
        </div>
    </div>
<!-- MODAL CONFIG DE WORKSPACE -->
    <div id="workspace-config-modal"
         class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden items-center justify-center p-4 z-50">

        <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl p-6 overflow-y-auto max-h-[90vh]">

            <h3 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">
                Configurar Propiedades del Espacio
            </h3>

            <form id="workspace-config-form" class="space-y-4">
                <input type="hidden" id="config-workspace-id">

                <div class="space-y-2">
                    <label for="config-workspace-name"
                           class="block text-sm font-medium text-gray-700">
                        Nombre del Espacio
                    </label>

                    <input type="text" id="config-workspace-name"
                           class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 
                                  focus:border-indigo-500 focus:ring-indigo-500">
                </div>

                <div class="mt-4">
                    <h4 class="text-lg font-semibold text-gray-800 mb-3">
                        Propiedades (Columnas)
                    </h4>

                    <div id="properties-list"
                         class="space-y-3 p-3 border rounded-lg bg-gray-50"></div>

                    <button type="button" onclick="addPropertyField()"
                        class="mt-3 px-4 py-2 bg-green-500 text-white font-semibold rounded-lg 
                               hover:bg-green-600 text-sm">
                        + Agregar Propiedad
                    </button>
                </div>

                <div class="mt-6 flex justify-end space-x-3">
                    <button type="button" onclick="closeModal('workspace-config-modal')"
                        class="px-4 py-2 bg-gray-300 text-gray-800 font-semibold rounded-lg hover:bg-gray-400">
                        Cancelar
                    </button>

                    <button type="submit"
                        class="px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md 
                               hover:bg-indigo-700">
                        Guardar Configuraci√≥n
                    </button>
                </div>
            </form>

        </div>
    </div>

    <!-- MODAL PERFIL USUARIO -->
    <div id="user-modal"
         class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden items-center justify-center p-4 z-50">

        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg p-6">

            <h3 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">Mi Perfil</h3>

            <div class="space-y-3 text-sm">
                <p class="text-gray-600">
                    El ID de usuario es local para Dexie. No es relevante para Gist,
                    pero se conserva para mantener la estructura local.
                </p>

                <div class="bg-indigo-50 p-3 rounded-lg break-words">
                    <strong class="text-indigo-700">ID de Usuario Local:</strong>
                    <span id="auth-user-id">Generado Localmente</span>
                </div>

                <div class="space-y-2 pt-2">

                    <label for="user-input-name"
                           class="block text-sm font-medium text-gray-700">
                        Nombre Visible
                    </label>

                    <input type="text" id="user-input-name" placeholder="Tu Nombre"
                           class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2
                                  focus:border-indigo-500 focus:ring-indigo-500">

                    <label for="user-input-branch"
                           class="block text-sm font-medium text-gray-700">
                        Sucursal/√Årea
                    </label>

                    <input type="text" id="user-input-branch" placeholder="Recursos Humanos"
                           class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2
                                  focus:border-indigo-500 focus:ring-indigo-500">

                </div>
            </div>

            <div class="mt-6 flex justify-end space-x-3">
                
                <button type="button" onclick="closeModal('user-modal')"
                        class="px-4 py-2 bg-gray-300 text-gray-800 font-semibold rounded-lg hover:bg-gray-400">
                    Cerrar
                </button>

                <button type="button" onclick="saveUserProfile()"
                        class="px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md 
                               hover:bg-indigo-700">
                    Guardar Perfil
                </button>

            </div>

        </div>
    </div>

    <!-- MODAL CONFIGURACI√ìN / SINCRONIZACI√ìN GIST -->
    <div id="config-modal"
        class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden items-center justify-center p-4 z-50">

        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg p-6">

            <h3 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">
                Configuraci√≥n y Sincronizaci√≥n Gist
            </h3>

            <div class="space-y-4">

                <p class="text-gray-600">
                    Usa GitHub Gist para exportar/importar la base de datos completa.<br>
                    Necesitas un Token Personal (permiso Gist).
                </p>

                <div class="space-y-2">
                    <label for="github-token"
                           class="block text-sm font-medium text-gray-700">
                        Token Personal de GitHub
                    </label>

                    <input type="password" id="github-token" placeholder="ghp_..."
                           class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3  
                                  focus:border-indigo-500 focus:ring-indigo-500">
                </div>

                <div class="space-y-2">
                    <label for="gist-id"
                           class="block text-sm font-medium text-gray-700">
                        ID del Gist
                    </label>

                    <input type="text" id="gist-id" placeholder="ID del Gist"
                           class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 
                                  focus:border-indigo-500 focus:ring-indigo-500">
                </div>

            </div>

            <div class="mt-6 flex justify-between space-x-3">

                <button type="button" onclick="saveSyncConfig()"
                        class="px-4 py-2 bg-gray-400 text-white font-semibold rounded-lg shadow-md hover:bg-gray-500">
                    Guardar Configuraci√≥n
                </button>

                <button type="button" onclick="importFromGist()"
                        class="px-4 py-2 bg-indigo-500 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-600">
                    Importar de Gist
                </button>

                <button type="button" onclick="closeModal('config-modal')"
                        class="px-4 py-2 bg-gray-300 text-gray-800 font-semibold rounded-lg hover:bg-gray-400">
                    Cerrar
                </button>

            </div>

        </div>
    </div>

    <!-- Inicia c√≥digo JS completo -->
    <script type="module">

        /* ========================
           CONFIGURACI√ìN GLOBAL
           ======================== */

        const userId = 'local-user-' + 
            (localStorage.getItem('localUserId') || crypto.randomUUID());
        
        localStorage.setItem('localUserId', userId);

        const state = {
            currentWorkspaceId: null,
            workspaces: [],
            currentRecords: [],
            currentView: 'panel',
            userProfile: { 
                name: 'Usuario Local', 
                branch: 'Configurar', 
                avatar: 'üßë‚Äçüíª', 
                id: userId 
            },
            gistConfig: { token: '', gistId: '' }
        };

        /* ========================
           BASE DE DATOS DEXIE
           ======================== */

        const dbLocal = new Dexie('NotionHRDB');
        
        dbLocal.version(1).stores({
            workspaces: '++id, name',
            records: '++id, workspaceId, title, properties',
            config: '&key'
        });
/* ========================
            INICIALIZACI√ìN
        ======================== */

        async function initApp() {
            await loadConfig();
            await loadUserProfile();
            await loadWorkspaces();

            if (state.workspaces.length > 0) {
                state.currentWorkspaceId = state.workspaces[0].id;
                setActiveWorkspace(state.currentWorkspaceId);
            } else {
                addWorkspace();
            }
        }

        /* ========================
           CARGAR CONFIGURACIONES
           ======================== */

        async function loadConfig() {
            const config = await dbLocal.config.get({ key: 'gistConfig' });
            if (config) state.gistConfig = config.value;
        }

        async function saveSyncConfig() {
            const token = document.getElementById('github-token').value.trim();
            const gistId = document.getElementById('gist-id').value.trim();

            state.gistConfig = { token, gistId };

            await dbLocal.config.put({
                key: 'gistConfig',
                value: state.gistConfig
            });

            showMessage("Configuraci√≥n guardada correctamente", "success");
        }

        /* ========================
           PERFIL DE USUARIO
           ======================== */

        async function loadUserProfile() {
            const saved = await dbLocal.config.get({ key: 'userProfile' });
            if (saved) state.userProfile = saved.value;

            document.getElementById('user-name-display').textContent = state.userProfile.name;
            document.getElementById('user-branch-display').textContent = state.userProfile.branch;
            document.getElementById('user-avatar').textContent = state.userProfile.avatar;
            document.getElementById('auth-user-id').textContent = state.userProfile.id;
        }

        async function saveUserProfile() {
            const name = document.getElementById('user-input-name').value.trim();
            const branch = document.getElementById('user-input-branch').value.trim();

            state.userProfile.name = name || state.userProfile.name;
            state.userProfile.branch = branch || state.userProfile.branch;

            await dbLocal.config.put({
                key: 'userProfile',
                value: state.userProfile
            });

            loadUserProfile();
            closeModal('user-modal');
            showMessage("Perfil actualizado", "success");
        }

        function showUserModal() {
            document.getElementById('user-input-name').value = state.userProfile.name;
            document.getElementById('user-input-branch').value = state.userProfile.branch;
            openModal('user-modal');
        }

        /* ========================
           WORKSPACES
        ======================== */

        async function loadWorkspaces() {
            state.workspaces = await dbLocal.workspaces.toArray();
            renderWorkspaceList();
        }

        async function addWorkspace() {
            const newWs = {
                name: "Nuevo Espacio",
                properties: [
                    { name: 'T√≠tulo', type: 'text' },
                    { name: 'Fecha', type: 'date' },
                    { name: 'Estado', type: 'select', options: ['Pendiente','En Proceso','Terminado'] }
                ]
            };

            const id = await dbLocal.workspaces.add(newWs);
            state.workspaces.push({ id, ...newWs });

            renderWorkspaceList();
            setActiveWorkspace(id);
        }

        function renderWorkspaceList() {
            const list = document.getElementById('workspace-list');
            list.innerHTML = "";

            state.workspaces.forEach(ws => {
                const btn = document.createElement('button');
                btn.className = "w-full text-left p-2 rounded-lg hover:bg-gray-100 text-gray-800";
                btn.textContent = ws.name;
                btn.onclick = () => setActiveWorkspace(ws.id);

                list.appendChild(btn);
            });
        }

        async function setActiveWorkspace(id) {
            state.currentWorkspaceId = id;

            const workspace = state.workspaces.find(w => w.id === id);
            document.getElementById('current-workspace-title').textContent = workspace.name;

            document.getElementById('btn-configure-ws').classList.remove("hidden");

            await loadRecords(id);
            renderTabs();
            renderContent();
        }

        /* ========================
           REGISTROS
        ======================== */

        async function loadRecords(workspaceId) {
            state.currentRecords = await dbLocal.records
                .where("workspaceId")
                .equals(workspaceId)
                .toArray();
        }

        function showItemModal(record = null) {
            const modal = document.getElementById('item-modal');
            const titleEl = document.getElementById('item-modal-title');
            const deleteBtn = document.getElementById('btn-delete-record');

            if (record) {
                titleEl.textContent = "Editar Elemento";
                deleteBtn.classList.remove("hidden");
                fillRecordForm(record);
            } else {
                titleEl.textContent = "Nuevo Elemento";
                deleteBtn.classList.add("hidden");
                clearRecordForm();
            }

            openModal('item-modal');
        }

        function fillRecordForm(record) {
            document.getElementById('record-id').value = record.id;
            document.getElementById('record-workspaceId').value = record.workspaceId;

            const ws = state.workspaces.find(w => w.id === record.workspaceId);
            const container = document.getElementById('dynamic-properties-container');
            container.innerHTML = "";

            ws.properties.forEach(prop => {
                const value = record.properties[prop.name] || "";

                const field = document.createElement('div');
                field.innerHTML = `
                    <label class="block text-xs font-semibold text-gray-700">${prop.name}</label>
                    ${generateInputForProperty(prop, value)}
                `;

                container.appendChild(field);
            });

            document.getElementById('record-content-block').value = record.content || "";
        }

        function clearRecordForm() {
            document.getElementById('record-id').value = "";
            document.getElementById('record-workspaceId').value = state.currentWorkspaceId;
            document.getElementById('dynamic-properties-container').innerHTML = "";
            document.getElementById('record-content-block').value = "";

            const ws = state.workspaces.find(w => w.id === state.currentWorkspaceId);
            ws.properties.forEach(prop => {
                const container = document.getElementById('dynamic-properties-container');
                const div = document.createElement('div');

                div.innerHTML = `
                    <label class="block text-xs font-semibold text-gray-700">${prop.name}</label>
                    ${generateInputForProperty(prop)}
                `;

                container.appendChild(div);
            });
        }

        function generateInputForProperty(prop, value = "") {
            switch (prop.type) {
                case 'text':
                    return `<input type="text" class="block w-full rounded-lg border-gray-300 shadow-sm p-2" 
                                 data-prop="${prop.name}" value="${value}">`;
                case 'number':
                    return `<input type="number" class="block w-full rounded-lg border-gray-300 shadow-sm p-2" 
                                 data-prop="${prop.name}" value="${value}">`;
                case 'date':
                    return `<input type="date" class="block w-full rounded-lg border-gray-300 shadow-sm p-2" 
                                 data-prop="${prop.name}" value="${value}">`;
                case 'select':
                    return `
                        <select class="block w-full rounded-lg border-gray-300 shadow-sm p-2" 
                                data-prop="${prop.name}">
                            ${prop.options.map(op => 
                                `<option value="${op}" ${op === value ? 'selected' : ''}>${op}</option>`
                            ).join('')}
                        </select>
                    `;
                default:
                    return "";
            }
        }

        /* Guardar registro */
        document.getElementById('record-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const id = document.getElementById('record-id').value;
            const workspaceId = Number(document.getElementById('record-workspaceId').value);

            const ws = state.workspaces.find(w => w.id === workspaceId);
            const props = {};

            document.querySelectorAll('[data-prop]').forEach(input => {
                props[input.dataset.prop] = input.value;
            });

            const recordData = {
                workspaceId,
                title: props['T√≠tulo'] || "Sin T√≠tulo",
                properties: props,
                content: document.getElementById('record-content-block').value
            };

            if (id) {
                await dbLocal.records.update(Number(id), recordData);
            } else {
                await dbLocal.records.add(recordData);
            }

            await loadRecords(workspaceId);
            renderContent();
            closeModal('item-modal');
            showMessage("Elemento guardado correctamente", "success");
        });
/* ========================
           ELIMINAR REGISTRO
        ======================== */

        async function deleteRecord(id) {
            if (!confirm("¬øEliminar este elemento?")) return;

            await dbLocal.records.delete(Number(id));
            await loadRecords(state.currentWorkspaceId);

            renderContent();
            closeModal('item-modal');
            showMessage("Elemento eliminado", "success");
        }

        /* ========================
           TABS / VISTAS
        ======================== */

        function renderTabs() {
            const container = document.getElementById('view-tabs');
            container.innerHTML = "";

            const tabs = [
                { id: 'panel', label: 'Panel' },
                { id: 'tabla', label: 'Tabla' },
                { id: 'agenda', label: 'Agenda' },
                { id: 'kanban', label: 'Kanban' }
            ];

            tabs.forEach(t => {
                const btn = document.createElement('button');
                btn.textContent = t.label;
                btn.dataset.view = t.id;

                btn.className =
                    "px-4 py-2 rounded-lg text-sm font-semibold transition-colors tab-button " +
                    (state.currentView === t.id
                        ? "active"
                        : "hover:bg-gray-100 text-gray-600");

                btn.onclick = () => {
                    state.currentView = t.id;
                    renderTabs();
                    renderContent();
                };

                container.appendChild(btn);
            });
        }

        /* ========================
           RENDERIZAR VISTAS
        ======================== */

        function renderContent() {
            switch (state.currentView) {
                case "panel":
                    renderPanel();
                    break;
                case "tabla":
                    renderTable();
                    break;
                case "agenda":
                    renderAgenda();
                    break;
                case "kanban":
                    renderKanban();
                    break;
            }
        }

        /* PANEL */
        function renderPanel() {
            const container = document.getElementById('content-view');

            container.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">

                    <div class="p-6 bg-indigo-50 rounded-xl shadow">
                        <p class="text-6xl font-extrabold text-indigo-600">${state.currentRecords.length}</p>
                        <p class="text-gray-600 font-semibold">TOTAL REGISTROS</p>
                    </div>

                    <div class="p-6 bg-green-50 rounded-xl shadow">
                        <p class="text-6xl font-extrabold text-green-600">
                            ${state.currentRecords.filter(r => r.properties.Estado === "Terminado").length}
                        </p>
                        <p class="text-gray-600 font-semibold">TERMINADOS</p>
                    </div>

                    <div class="p-6 bg-yellow-50 rounded-xl shadow">
                        <p class="text-6xl font-extrabold text-yellow-600">
                            ${state.currentRecords.filter(r => r.properties.Estado === "Pendiente").length}
                        </p>
                        <p class="text-gray-600 font-semibold">PENDIENTES</p>
                    </div>

                </div>
            `;
        }

        /* TABLA */
        function renderTable() {
            const container = document.getElementById('content-view');
            const ws = state.workspaces.find(w => w.id === state.currentWorkspaceId);

            let html = `
                <table class="min-w-full text-sm border-collapse">
                    <thead>
                        <tr class="border-b bg-gray-50">
                            ${ws.properties.map(p =>
                                `<th class="p-2 text-left font-semibold text-gray-700">${p.name}</th>`
                            ).join("")}
                            <th class="p-2"></th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            state.currentRecords.forEach(r => {
                html += `
                    <tr class="border-b hover:bg-gray-50">
                        ${ws.properties.map(p =>
                            `<td class="p-2 editable-cell" onclick="showItemModal(${r.id})">
                                ${r.properties[p.name] || ""}
                            </td>`
                        ).join("")}
                        <td class="p-2 text-right">
                            <button onclick="showItemModal(${r.id})"
                                class="text-indigo-600 hover:text-indigo-800">Editar</button>
                        </td>
                    </tr>
                `;
            });

            html += "</tbody></table>";
            container.innerHTML = html;
        }

        /* AGENDA */
        function renderAgenda() {
            const container = document.getElementById('content-view');
            container.innerHTML = `<div id="calendar"></div>`;

            const events = state.currentRecords.map(r => ({
                title: r.title,
                start: r.properties["Fecha"],
                backgroundColor: "#6366f1"   /* ‚Üê corregido (antes ten√≠a ##) */
            }));

            const calendar = new FullCalendar.Calendar(
                document.getElementById('calendar'),
                {
                    initialView: "dayGridMonth",
                    selectable: true,
                    events
                }
            );

            calendar.render();
        }

        /* KANBAN */
        function renderKanban() {
            const container = document.getElementById('content-view');

            const statuses = ["Pendiente", "En Proceso", "Terminado"];

            let html = `
                <div class="flex space-x-4 overflow-x-auto pb-4">
            `;

            statuses.forEach(status => {
                html += `
                    <div class="kanban-column bg-gray-50 rounded-xl p-3 shadow"
                         data-status="${status}">
                        <h3 class="font-bold text-gray-700 mb-2">${status}</h3>
                        <div class="kanban-list space-y-3" data-list="${status}">
                            ${state.currentRecords
                                .filter(r => r.properties.Estado === status)
                                .map(r => `
                                    <div class="kanban-card bg-white p-3 rounded-lg shadow cursor-pointer"
                                         draggable="true"
                                         data-id="${r.id}"
                                         onclick="showItemModal(${r.id})">
                                        <p class="font-semibold">${r.title}</p>
                                        <p class="text-xs text-gray-500">${r.properties.Fecha || ""}</p>
                                    </div>
                                `)
                                .join("")}
                        </div>
                    </div>
                `;
            });

            html += "</div>";
            container.innerHTML = html;

            initKanbanDrag();
        }

        function initKanbanDrag() {
            const cards = document.querySelectorAll(".kanban-card");
            const lists = document.querySelectorAll(".kanban-list");

            let dragged = null;

            cards.forEach(card => {
                card.addEventListener("dragstart", () => {
                    dragged = card;
                    setTimeout(() => card.classList.add("opacity-50"), 0);
                });

                card.addEventListener("dragend", () => {
                    card.classList.remove("opacity-50");
                    dragged = null;
                });
            });

            lists.forEach(list => {
                list.addEventListener("dragover", e => e.preventDefault());

                list.addEventListener("drop", async () => {
                    if (!dragged) return;

                    const id = Number(dragged.dataset.id);

                    await dbLocal.records.update(id, {
                        properties: {
                            ...state.currentRecords.find(r => r.id === id).properties,
                            Estado: list.dataset.list
                        }
                    });

                    await loadRecords(state.currentWorkspaceId);
                    renderKanban();
                });
            });
        }

        /* ========================
           MODALES
        ======================== */

        function openModal(id) {
            document.getElementById(id).classList.remove("hidden");
            document.getElementById(id).classList.add("flex");
        }

        function closeModal(id) {
            document.getElementById(id).classList.add("hidden");
            document.getElementById(id).classList.remove("flex");
        }

        /* ========================
           MENSAJES
        ======================== */

        function showMessage(text, type = "success") {
            const box = document.getElementById('app-message');
            box.textContent = text;

            box.className =
                `fixed bottom-4 right-4 p-3 rounded-lg shadow-xl text-sm 
                 ${type === "error" ? "bg-red-500 text-white" : "bg-green-500 text-white"}`;

            box.classList.remove("hidden");

            setTimeout(() => box.classList.add("hidden"), 2500);
        }
<script src="./assets/js/properties.js"></script>
<script src="./assets/js/rules.js"></script>
<script src="./assets/js/views.js"></script>
<script src="./assets/js/agendaView.js></script>
<script src="./assets/js/kanbanNative.js></script>
<script src="./assets/js/menuInject.js></script>
<script src="./assets/js/zoom.js></script>

        /* ========================
           SERVICE WORKER
        ======================== */

        if ("serviceWorker" in navigator) {
            navigator.serviceWorker.register("./sw.js")
                .catch(console.error);
        }

        /* ========================
           INICIO DE LA APP
        ======================== */

        initApp();

    </script>

</body>
</html>
